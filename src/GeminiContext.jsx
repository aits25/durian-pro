import { createContext, useContext } from 'react';
import { GoogleGenerativeAI } from '@google/generative-ai';

const GeminiContext = createContext();

export const GeminiProvider = ({ children }) => {
  const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY || 'YOUR_GEMINI_API_KEY_HERE';
  
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
  const model = genAI.getGenerativeModel({ model: 'gemini-1.5-pro' });

  const askAIAdvisor = async (question, context = '') => {
    try {
      const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏µ‡πà:
1. ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä (‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏∂‡πà‡∏á, ‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢, ‡∏£‡∏≤‡∏Ñ‡∏≥, ‡∏´‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π)
2. ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡∏§‡∏î‡∏π‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ï.‡∏Å‡∏£‡∏∏‡∏á‡∏ä‡∏¥‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå

‡∏ö‡∏£‡∏¥‡∏ö‡∏ó:
- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏õ‡∏•‡∏π‡∏Å: 6 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á, ‡∏ñ‡πâ‡∏≥‡∏´‡∏•‡∏ß‡∏á, ‡∏™‡∏ß‡∏ô‡∏ô‡∏ö, ‡πÑ‡∏ó‡∏£‡∏´‡πâ‡∏≠‡∏¢, ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, 13 ‡πÑ‡∏£‡πà)
- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡∏ï.‡∏Å‡∏£‡∏∏‡∏á‡∏ä‡∏¥‡∏á ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏≥‡∏î‡∏ß‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå
- ‡∏†‡∏π‡∏°‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏ä‡∏∑‡πâ‡∏ô (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
- ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏∂‡πà‡∏á, ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ä‡∏∑‡πâ‡∏ô, ‡∏ù‡∏ô‡∏ï‡∏Å‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•
${context}

‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏£:
- ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
- ‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
- ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç`;

      const prompt = `${systemPrompt}\n\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${question}`;

      const result = await model.generateContent(prompt);
      const response = await result.response;
      return response.text();
    } catch (error) {
      console.error('Gemini API Error:', error);
      
      // Fallback: ‡πÉ‡∏´‡πâ mock response ‡πÄ‡∏°‡∏∑‡πà‡∏≠ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
      const mockResponses = {
        '‡πÇ‡∏£‡∏Ñ': '‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏∂‡πà‡∏á (Anthracnose) ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ô‡πà‡∏≤:\n\nüìå ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:\n- ‡∏ú‡∏•‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏Ç‡πâ‡∏°\n- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏¢‡∏±‡πà‡∏á‡∏•‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ\n- ‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÅ‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏î‡∏á\n\nüõ°Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô:\n1. ‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó\n2. ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô\n3. ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡∏ô‡πÇ‡∏Ñ‡πÄ‡∏ã‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≤‡∏£‡πå‡πÄ‡∏ö‡∏ô‡∏î‡∏≤‡∏ã‡∏¥‡∏°\n4. ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å',
        '‡∏õ‡∏∏‡πã‡∏¢': '‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ï.‡∏Å‡∏£‡∏∏‡∏á‡∏ä‡∏¥‡∏á:\n\nüìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢:\n- ‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß (‡∏û.‡∏¢.-‡∏°.‡∏Ñ.): ‡∏õ‡∏∏‡πã‡∏¢‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô + ‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°\n- ‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô (‡∏Å.‡∏û.-‡πÄ‡∏°.‡∏¢.): ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏î‡∏≠‡∏Å\n- ‡∏§‡∏î‡∏π‡∏ù‡∏ô (‡∏û.‡∏Ñ.-‡∏ï.‡∏Ñ.): ‡∏•‡∏î‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏Å‡∏±‡∏î ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∞‡∏ï‡∏∞‡πÅ‡∏£‡πà\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n- ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ 3-4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏õ‡∏µ\n- ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏π‡∏ï‡∏£ 5-5-5 ‡∏´‡∏£‡∏∑‡∏≠ 8-24-24 ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏¢‡∏∞\n- ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô',
        '‡∏ô‡πâ‡∏≠‡∏Å': '‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡∏§‡∏î‡∏π‡πÉ‡∏ô‡∏ï.‡∏Å‡∏£‡∏∏‡∏á‡∏ä‡∏¥‡∏á:\n\nüéØ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£:\n1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πâ‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏ 3-5 ‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á\n2. ‡πÉ‡∏ä‡πâ‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏î‡∏≠‡∏Å (KNO‚ÇÉ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°)\n3. ‡∏•‡∏î‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏à‡∏£‡∏¥‡∏ç\n4. ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ\n5. ‡∏ö‡∏±‡∏á‡πÅ‡∏™‡∏á 40-50 ‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å\n\n‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
      };
      
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ keyword ‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
      let response = '‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö API ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á üòû\n\n';
      for (const [key, value] of Object.entries(mockResponses)) {
        if (question.toLowerCase().includes(key)) {
          response = value;
          break;
        }
      }
      
      if (response === '‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö API ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á üòû\n\n') {
        response += '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini API ‡πÑ‡∏î‡πâ\n\n' +
          'üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n' +
          '1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n' +
          '2. ‡πÄ‡∏õ‡∏¥‡∏î billing ‡πÉ‡∏ô Google Cloud Console\n' +
          '3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏ü‡∏£‡∏µ‡πÑ‡∏ï‡∏£‡∏≠‡∏±‡∏• quota ‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n\n' +
          'üí° ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n' +
          '- ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ‡πÑ‡∏õ billing account\n' +
          '- ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ quota ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
      }
      
      throw new Error(response);
    }
  };

  return (
    <GeminiContext.Provider value={{ askAIAdvisor }}>
      {children}
    </GeminiContext.Provider>
  );
};

export const useGemini = () => {
  const context = useContext(GeminiContext);
  if (!context) {
    throw new Error('useGemini must be used within GeminiProvider');
  }
  return context;
};
